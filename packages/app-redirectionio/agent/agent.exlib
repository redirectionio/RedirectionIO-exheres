# Copyright 2019 redirection.io <contact@redirection.io>
# Distributed under the terms of the MIT License

require systemd-service [ systemd_files=[ "redirection-agent/redirectionio-agent.service" ] ]

export_exlib_phases src_unpack src_install

SUMMARY="redirection.io Agent."
HOMEPAGE="https://redirection.io"
DOWNLOADS="https://packages.redirection.io/dist/${PV}/redirectionio-agent_${PV}-1_any_amd64.tar.gz"

LICENCES="MIT"
SLOT="0"

DEPENDENCIES="
    build+run:
        group/redirectionio
        user/redirectionio
        sys-apps/systemd
"

agent_src_unpack() {
    edo mkdir "${WORK}"
    edo cd "${WORK}"
    unpack --if-compressed ${ARCHIVES}
}

agent_src_install() {
    local config=/etc/redirectionio
    local lib=/var/lib/redirectionio
    local target=/usr/$(exhost --target)/bin

    edo mkdir -p "${IMAGE}"/${config}
    edo mkdir -p "${IMAGE}"/${lib}
    edo mkdir -p "${IMAGE}"/${target}

    edo touch "${IMAGE}"/${lib}/.keep
    edo mv redirection-agent/agent.yml "${IMAGE}"/${config}/agent.yml
    edo mv redirection-agent/redirectionio-agent "${IMAGE}"/${target}/redirectionio-agent

    install_systemd_files
}

BUGS_TO="contact@redirection.io"
